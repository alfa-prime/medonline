# Обзор продукта

Medical Extractor — это веб-сервис на базе FastAPI, который извлекает и обрабатывает медицинские данные из платформы EVMIAS (Электронная медико-информационно-аналитическая система).

## Основной функционал
- Поиск пациентов и получение данных из внешних медицинских систем
- Извлечение и парсинг результатов медицинских анализов
- Поддержка различных типов медицинских данных:
  - Лабораторные анализы (medtest)
  - Функциональные тесты
  - УЗИ-сканирование
  - Рентгенография
- Парсинг и санитизация HTML медицинских отчетов
- Управление аутентификацией через cookies для доступа к внешним API

## Ключевые особенности
- Асинхронная обработка для повышения производительности
- Структурированное извлечение данных из HTML медицинских отчетов
- RESTful API с документацией OpenAPI
- Контейнеризованное развертывание с Docker
- Комплексное логирование и обработка ошибок

# Технологический стек

## Основные фреймворки и библиотеки
- **FastAPI** - Современный асинхронный веб-фреймворк для создания API
- **Pydantic** - Валидация данных и управление настройками
- **HTTPX** - Асинхронный HTTP-клиент для внешних API вызовов
- **Loguru** - Продвинутое логирование с ротацией и сжатием
- **Tenacity** - Логика повторных попыток для устойчивых операций

## Обработка данных
- **BeautifulSoup4** - Парсинг и манипуляция HTML
- **lxml** - Бэкенд парсера XML/HTML
- **htmlmin** - Минификация HTML

## Инфраструктура
- **Docker** - Контейнеризация с многоэтапной сборкой
- **Python 3.10** - Среда выполнения
- **Uvicorn** - ASGI сервер

## Основные команды

### Разработка
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск сервера разработки
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Docker операции
```bash
# Сборка и запуск с Docker Compose
docker-compose up --build

# Запуск в фоновом режиме
docker-compose up -d

# Просмотр логов
docker-compose logs -f app

# Остановка сервисов
docker-compose down
```

### Проверка работоспособности
```bash
# Проверка здоровья приложения
curl http://localhost:8000/health/ping
```

## Конфигурация
- Переменные окружения управляются через файл `.env`
- Pydantic Settings для типобезопасной конфигурации
- LRU кэширование настроек для оптимизации производительности

# Структура проекта

## Архитектурные принципы
- **Слоистая архитектура** - четкое разделение между маршрутами, сервисами и моделями
- **Dependency Injection** - использование FastAPI зависимостей для управления состоянием
- **Асинхронное программирование** - все операции ввода-вывода выполняются асинхронно
- **Паттерн Pipeline** - каждый сервис имеет свой pipeline для обработки данных

## Структура каталогов

### `/app` - Основное приложение
- `main.py` - точка входа FastAPI приложения с настройкой жизненного цикла
- `__init__.py` - инициализация пакета

### `/app/core` - Основные компоненты
- `config.py` - конфигурация приложения через Pydantic Settings
- `dependencies.py` - FastAPI зависимости (например, валидация cookies)
- `httpx_client.py` - синглтон HTTP-клиента для внешних запросов
- `logger.py` - настройка логирования через Loguru

### `/app/models` - Модели данных
- `patient.py` - Pydantic модели для валидации запросов пациентов

### `/app/route` - API маршруты
- Организованы по функциональным областям
- Используют FastAPI роутеры для группировки эндпоинтов

### `/app/services` - Бизнес-логика
Каждый сервис организован как отдельный модуль:
- `cookies/` - управление аутентификацией и cookies
- `medtest/` - обработка лабораторных анализов
- `functional_tests/` - функциональные тесты
- `ultrasound_scan/` - УЗИ сканирование
- `x_ray/` - рентгенография

#### Структура сервиса
```
service_name/
├── __init__.py
├── pipeline.py      # Основная логика обработки данных
└── manager.py       # Управление состоянием (если необходимо)
```

## Соглашения по именованию

### Файлы и модули
- Используйте snake_case для имен файлов и модулей
- Группируйте связанную функциональность в отдельные модули

### Функции и переменные
- snake_case для функций и переменных
- Асинхронные функции должны начинаться с `async def`
- Константы в UPPER_CASE

### Классы
- PascalCase для имен классов
- Pydantic модели наследуются от `BaseModel`
- Settings классы наследуются от `BaseSettings`

## Паттерны кода

### Обработка ошибок
- Используйте try/except блоки в pipeline функциях
- Логируйте ошибки через logger с соответствующим уровнем
- Возвращайте None при ошибках вместо выброса исключений

### Асинхронность
- Все внешние HTTP запросы через HTTPXClient
- Используйте `asyncio.gather()` для параллельных операций
- Применяйте `await` для всех асинхронных вызовов

### Логирование
- Используйте константы LOG_TEST_NAME для идентификации сервисов
- Логируйте начало и завершение операций
- Включайте контекстную информацию (имена пациентов, количество результатов)